stages:
  - install
  #- bootstrap
  #- lint
  #- test
#  - coverage
  - build
  - release

variables:
  npm_config_cache: "$CI_PROJECT_DIR/.npm"
  API: "kcfirebrigade"
#  CI_DEBUG_TRACE: "true"

.default-job-settings:
  tags:
    - npm
    - docker
    - yarn

install:
  extends: .default-job-settings
  stage: install
  script:
    - yarn install
  cache:
    paths:
      - .npm/
      - node_modules/
  artifacts:
    name: "artifacts"
    untracked: true
    expire_in: 60 mins
    paths:
      - .npm/
      - node_modules/

bootstrap:
  extends: .default-job-settings
  stage: bootstrap
  script:
    - yarn bootstrap
  dependencies:
    - install

lint:
 extends: .default-job-settings
 stage: lint
 variables:
   NODE_ENV: "development"
 script:
   - yarn lint:ts
 dependencies:
   - install

test:
  extends: .default-job-settings
  stage: test
  variables:
    API: ""
  script:
    - yarn test
  dependencies:
    - install

build:
  extends: .default-job-settings
  stage: build
  variables:
    NODE_ENV: "production"
  script:
    - echo $API
    - echo $NODE_ENV
    - yarn build
  dependencies:
    - install
  artifacts:
    paths:
      - k2-dev/base/dist

release:
  extends: .default-job-settings
  stage: release
  script:
    - yarn config set registry "https://nexus.kontur.io/repository/npm-snapshots-a/:_authToken=$NEXUS_NPM_TOKEN"
    - yarn lerna:publish
  dependencies:
    - install
